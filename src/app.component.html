<div class="flex flex-col h-screen overflow-hidden font-sans transition-colors duration-500"
     [class.bg-slate-950]="!isTerminalMode()" 
     [class.text-slate-200]="!isTerminalMode()"
     [class.bg-black]="isTerminalMode()"
     [class.text-green-500]="isTerminalMode()"
     [class.font-mono]="isTerminalMode()">
  
  <!-- Header -->
  <header class="flex-none h-14 md:h-16 border-b flex items-center justify-between px-3 md:px-6 backdrop-blur-sm z-10 transition-colors duration-500"
          [class.border-slate-800]="!isTerminalMode()"
          [class.bg-slate-900_50]="!isTerminalMode()"
          [class.border-green-800]="isTerminalMode()"
          [class.bg-black]="isTerminalMode()">
          
    <div class="flex items-center gap-2 md:gap-3">
      <div class="w-6 h-6 md:w-8 md:h-8 rounded flex items-center justify-center transition-all duration-500"
           [class.bg-indigo-500]="!isTerminalMode()"
           [class.shadow-[0_0_15px_rgba(99,102,241,0.5)]]="!isTerminalMode()"
           [class.bg-green-700]="isTerminalMode()"
           [class.shadow-[0_0_15px_rgba(34,197,94,0.5)]]="isTerminalMode()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5 text-white">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" />
        </svg>
      </div>
      <div class="flex flex-col">
        <h1 class="text-sm md:text-xl font-bold tracking-tight leading-none" [class.text-white]="!isTerminalMode()">
          SENTINEL <span class="font-light" [class.text-indigo-400]="!isTerminalMode()">HONEYPOT</span>
        </h1>
        <div class="flex items-center gap-1 mt-0.5">
          <span class="text-[8px] md:text-[9px] uppercase tracking-widest" [class.text-slate-500]="!isTerminalMode()" [class.text-green-600]="isTerminalMode()">Engine:</span>
          <!-- Clickable Mode Switcher -->
          <button (click)="toggleBackendMode()" 
                  class="text-[8px] md:text-[9px] font-mono transition-colors duration-300 hover:underline cursor-pointer focus:outline-none uppercase"
                  [class]="backendMode() === 'PYTHON_LANGGRAPH' ? (isTerminalMode() ? 'text-green-400' : 'text-green-400') : (isTerminalMode() ? 'text-green-400' : 'text-blue-400')"
                  title="Click to toggle between Browser (Client) and Python (Server) mode">
            @if (backendMode() === 'CLIENT_OPENAI') {
              ChatGPT (Client)
            } @else if (backendMode() === 'PYTHON_LANGGRAPH') {
              Python (LangGraph)
            } @else {
              Gemini (Client)
            }
          </button>
        </div>
      </div>
    </div>
    
    <div class="flex items-center gap-2 md:gap-4">
      
      <!-- Terminal Toggle -->
      <button (click)="toggleTerminalMode()"
              class="hidden md:flex items-center justify-center w-8 h-8 rounded transition-all border"
              [class.bg-slate-800]="!isTerminalMode()"
              [class.border-slate-700]="!isTerminalMode()"
              [class.text-slate-400]="!isTerminalMode()"
              [class.bg-green-900_30]="isTerminalMode()"
              [class.border-green-700]="isTerminalMode()"
              [class.text-green-400]="isTerminalMode()"
              title="Toggle Terminal Mode">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
      </button>

      <!-- Audio Toggle -->
      <button (click)="toggleAudio()" 
              class="flex items-center justify-center w-8 h-8 rounded-full transition-all border"
              [class]="isAudioEnabled() 
                ? (isTerminalMode() ? 'bg-green-900 text-green-400 border-green-500' : 'bg-indigo-600/20 text-indigo-400 border-indigo-500/50') 
                : (isTerminalMode() ? 'bg-black text-green-800 border-green-900' : 'bg-slate-800 text-slate-500 border-slate-700')"
              title="Toggle Voice Simulation">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
      </button>

      <div class="px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-wider border flex items-center"
           [class]="isScamConfirmed() 
              ? (isTerminalMode() ? 'bg-red-900/30 border-red-500 text-red-500 animate-pulse' : 'bg-red-500/10 border-red-500/50 text-red-400 animate-pulse') 
              : (isTerminalMode() ? 'bg-green-900/30 border-green-500 text-green-500' : 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400')">
        @if (isScamConfirmed()) {
          <span class="md:hidden">‚ö†Ô∏è SCAM</span>
          <span class="hidden md:inline">‚ö†Ô∏è SCAM DETECTED</span>
        } @else {
          <span class="md:hidden">üõ°Ô∏è SECURE</span>
          <span class="hidden md:inline">üõ°Ô∏è SYSTEM SECURE</span>
        }
      </div>
      <button (click)="resetSession()" 
              class="text-[10px] md:text-xs px-3 py-1.5 rounded transition-colors border whitespace-nowrap"
              [class.bg-slate-800]="!isTerminalMode()"
              [class.hover:bg-slate-700]="!isTerminalMode()"
              [class.text-slate-300]="!isTerminalMode()"
              [class.border-slate-700]="!isTerminalMode()"
              [class.bg-black]="isTerminalMode()"
              [class.border-green-700]="isTerminalMode()"
              [class.text-green-500]="isTerminalMode()"
              [class.hover:bg-green-900]="isTerminalMode()">
        New Session
      </button>
    </div>
  </header>

  <!-- Main Layout -->
  <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
    
    <!-- LEFT COLUMN: Scammer Simulator (Chat) -->
    <!-- Mobile: Top half, Desktop: Left third -->
    <section class="w-full h-[45%] lg:h-full lg:w-1/3 flex flex-col border-b lg:border-b-0 lg:border-r relative"
             [class.border-slate-800]="!isTerminalMode()"
             [class.bg-slate-900_30]="!isTerminalMode()"
             [class.border-green-800]="isTerminalMode()"
             [class.bg-black]="isTerminalMode()">
             
      <div class="p-2 md:p-4 border-b flex flex-col gap-2"
           [class.bg-slate-900_80]="!isTerminalMode()"
           [class.border-slate-800]="!isTerminalMode()"
           [class.bg-black]="isTerminalMode()"
           [class.border-green-800]="isTerminalMode()">
           
        <div class="flex justify-between items-center">
          <h2 class="text-xs md:text-sm font-semibold uppercase tracking-widest flex items-center gap-2"
              [class.text-slate-400]="!isTerminalMode()"
              [class.text-green-600]="isTerminalMode()">
             Incoming Feed
             <button (click)="toggleMetadataSettings()" title="Configure Metadata"
                     [class.text-slate-500]="!isTerminalMode()"
                     [class.hover:text-indigo-400]="!isTerminalMode()"
                     [class.text-green-700]="isTerminalMode()"
                     [class.hover:text-green-400]="isTerminalMode()">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
             </button>
          </h2>
          <div class="flex gap-1.5 md:gap-2">
            <button (click)="fillScenario('bank')" class="text-[9px] md:text-[10px] px-2 py-1 rounded transition border"
                    [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.hover:bg-indigo-900_50]="!isTerminalMode()"
                    [class.bg-green-900_20]="isTerminalMode()" [class.border-green-700]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.hover:bg-green-900_50]="isTerminalMode()">Bank</button>
            <button (click)="fillScenario('job')" class="text-[9px] md:text-[10px] px-2 py-1 rounded transition border"
                    [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.hover:bg-indigo-900_50]="!isTerminalMode()"
                    [class.bg-green-900_20]="isTerminalMode()" [class.border-green-700]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.hover:bg-green-900_50]="isTerminalMode()">Job</button>
            <button (click)="fillScenario('lottery')" class="text-[9px] md:text-[10px] px-2 py-1 rounded transition border"
                    [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.hover:bg-indigo-900_50]="!isTerminalMode()"
                    [class.bg-green-900_20]="isTerminalMode()" [class.border-green-700]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.hover:bg-green-900_50]="isTerminalMode()">KBC</button>
          </div>
        </div>

        @if (showMetadataSettings()) {
          <div class="grid grid-cols-3 gap-2 p-2 rounded border animate-in fade-in slide-in-from-top-1"
               [class.bg-slate-950]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
               [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
             <div>
               <label class="text-[8px] uppercase block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Channel</label>
               <select [(ngModel)]="metaChannel" class="w-full text-[10px] rounded px-1 py-1 focus:outline-none border"
                       [class.bg-slate-900]="!isTerminalMode()" [class.text-slate-300]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()"
                       [class.bg-black]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                 <option value="SMS">SMS</option>
                 <option value="WhatsApp">WhatsApp</option>
                 <option value="Email">Email</option>
               </select>
             </div>
             <div>
               <label class="text-[8px] uppercase block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Language</label>
               <select [(ngModel)]="metaLanguage" class="w-full text-[10px] rounded px-1 py-1 focus:outline-none border"
                       [class.bg-slate-900]="!isTerminalMode()" [class.text-slate-300]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()"
                       [class.bg-black]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                 <option value="English">English</option>
                 <option value="Hinglish">Hinglish</option>
                 <option value="Hindi">Hindi</option>
               </select>
             </div>
             <div>
               <label class="text-[8px] uppercase block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Locale</label>
               <select [(ngModel)]="metaLocale" class="w-full text-[10px] rounded px-1 py-1 focus:outline-none border"
                       [class.bg-slate-900]="!isTerminalMode()" [class.text-slate-300]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()"
                       [class.bg-black]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                 <option value="IN">India (IN)</option>
                 <option value="US">USA (US)</option>
               </select>
             </div>
          </div>
        }
      </div>

      <!-- Chat History -->
      <div #chatContainer class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 md:space-y-4">
        @if (messages().length === 0) {
          <div class="h-full flex flex-col items-center justify-center space-y-2 opacity-50"
               [class.text-slate-600]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 md:h-12 md:w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <p class="text-xs md:text-sm">Waiting for incoming message...</p>
            <div class="flex gap-2 text-[10px]" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">
               <span>Mode: {{ metaChannel() }}</span>
            </div>
          </div>
        }

        @for (msg of messages(); track msg.timestamp) {
          <div class="flex flex-col" [class.items-end]="msg.sender === 'scammer'" [class.items-start]="msg.sender === 'agent'">
            <div class="max-w-[85%] md:max-w-[85%] rounded-2xl px-3 py-2 md:px-4 md:py-3 shadow-lg text-xs md:text-sm leading-relaxed relative group"
                 [class]="
                    msg.sender === 'scammer' 
                    ? (isTerminalMode() ? 'bg-green-900 text-green-100 rounded-br-none border border-green-600' : 'bg-indigo-600 text-white rounded-br-none') 
                    : (isTerminalMode() ? 'bg-black text-green-400 rounded-bl-none border border-green-800' : 'bg-slate-800 text-slate-200 rounded-bl-none border border-slate-700')
                 ">
              
              <div class="text-[8px] md:text-[10px] opacity-50 mb-1 font-mono uppercase">
                {{ msg.sender === 'agent' ? 'AGENT (Persona: Alex)' : 'SUSPECT' }}
              </div>
              
              {{ msg.text }}

              <!-- Timestamp -->
              <div class="text-[8px] md:text-[9px] opacity-30 text-right mt-1 font-mono">
                {{ msg.timestamp | date:'HH:mm:ss' }}
              </div>
            </div>
          </div>
        }
        
        <!-- Processing State (Brain/Network) -->
        @if (isProcessing()) {
          <div class="flex items-start animate-pulse">
            <div class="rounded-2xl rounded-bl-none px-3 py-2 md:px-4 md:py-3 border flex items-center gap-2"
                 [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.text-slate-400]="!isTerminalMode()"
                 [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-600]="isTerminalMode()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
              <span class="text-[10px] uppercase font-mono">Analysing Pattern...</span>
            </div>
          </div>
        }

        <!-- Typing State (Human Persona) -->
        @if (isAgentTyping()) {
          <div class="flex items-start">
            <div class="rounded-2xl rounded-bl-none px-3 py-2 md:px-4 md:py-3 border flex items-center gap-1"
                 [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.text-slate-400]="!isTerminalMode()"
                 [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-600]="isTerminalMode()">
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce"></div>
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-75"></div>
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-150"></div>
            </div>
          </div>
        }
      </div>

      <!-- Input Area -->
      <div class="p-2 md:p-4 border-t"
           [class.bg-slate-900]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
           [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
        <div class="relative">
          <input 
            type="text" 
            [(ngModel)]="newMessageText"
            (keyup.enter)="sendMessage()"
            placeholder="Type a scam message..." 
            [disabled]="isProcessing() || isAgentTyping()"
            class="w-full rounded-lg pl-3 pr-10 py-2 md:pl-4 md:pr-12 md:py-3 text-xs md:text-sm focus:outline-none border transition-all"
            [class.bg-slate-950]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.focus:border-indigo-500]="!isTerminalMode()" [class.placeholder:text-slate-600]="!isTerminalMode()"
            [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.focus:border-green-500]="isTerminalMode()" [class.placeholder:text-green-800]="isTerminalMode()" [class.text-green-500]="isTerminalMode()"
          >
          <button 
            (click)="sendMessage()"
            [disabled]="!newMessageText() || isProcessing() || isAgentTyping()"
            class="absolute right-1.5 top-1.5 md:right-2 md:top-2 p-1 md:p-1.5 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            [class.bg-indigo-600]="!isTerminalMode()" [class.text-white]="!isTerminalMode()" [class.hover:bg-indigo-500]="!isTerminalMode()"
            [class.bg-green-800]="isTerminalMode()" [class.text-green-100]="isTerminalMode()" [class.hover:bg-green-700]="isTerminalMode()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 md:w-4 md:h-4">
              <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z" />
            </svg>
          </button>
        </div>
      </div>
    </section>

    <!-- RIGHT COLUMN: Dashboard -->
    <!-- Mobile: Bottom half, Desktop: Right remaining -->
    <section class="w-full h-[55%] lg:h-full lg:flex-1 flex flex-col overflow-y-auto p-3 md:p-6 gap-3 md:gap-6"
             [class.bg-slate-950]="!isTerminalMode()"
             [class.bg-black]="isTerminalMode()">
      
      <!-- Top Row: Analysis & Agent Status -->
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-3 md:gap-6">
        
        <!-- Live Analysis Card -->
        <div class="border rounded-xl p-3 md:p-5 shadow-sm"
             [class.bg-slate-900_50]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
             [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
          <h3 class="text-xs font-bold uppercase tracking-wider mb-2 md:mb-4 flex items-center gap-2"
              [class.text-indigo-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            Agent Analysis
          </h3>
          <div class="space-y-3 md:space-y-4">
            <div>
              <label class="text-[9px] md:text-[10px] uppercase font-semibold" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Assessment</label>
              <p class="text-xs md:text-sm mt-1 whitespace-pre-wrap leading-relaxed" [class.text-slate-400]="!isTerminalMode() && !agentNotes()" [class.text-green-400]="isTerminalMode()">
                {{ agentNotes() || 'Waiting for analysis...' }}
              </p>
            </div>
            
            <div class="grid grid-cols-3 gap-2 md:gap-4">
              <div class="p-2 md:p-3 rounded border col-span-1"
                   [class.bg-slate-950]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
                   [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                <div class="text-[9px] md:text-[10px] uppercase" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Confidence</div>
                <div class="text-sm md:text-xl font-mono mt-1" 
                     [class.text-red-400]="confidenceScore() > 75 && !isTerminalMode()"
                     [class.text-yellow-400]="confidenceScore() > 40 && confidenceScore() <= 75 && !isTerminalMode()"
                     [class.text-emerald-400]="confidenceScore() <= 40 && !isTerminalMode()"
                     [class.text-green-500]="isTerminalMode()">
                  {{ confidenceScore() }}%
                </div>
              </div>

              <!-- Sparkline Visualization -->
              <div class="p-2 md:p-3 rounded border col-span-2 relative overflow-hidden"
                   [class.bg-slate-900]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
                   [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                <div class="text-[9px] md:text-[10px] uppercase absolute top-2 left-3" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Threat Trend</div>
                @if (confidenceHistory().length > 1) {
                  <svg class="w-full h-full absolute bottom-0 left-0" viewBox="0 0 100 40" preserveAspectRatio="none">
                     <polyline [attr.points]="confidencePoints()" 
                               fill="none" 
                               [attr.stroke]="isTerminalMode() ? '#22c55e' : '#818cf8'" 
                               stroke-width="2"
                               vector-effect="non-scaling-stroke" />
                  </svg>
                } @else {
                  <div class="flex items-center justify-center h-full text-[9px] italic pt-2" [class.text-slate-700]="!isTerminalMode()" [class.text-green-900]="isTerminalMode()">Not enough data</div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- EXTRACTED INTELLIGENCE CARD (Restored) -->
        <div class="border rounded-xl p-3 md:p-5 shadow-sm transition-colors duration-500"
             [class.bg-slate-900_50]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
             [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
          
          <h3 class="text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2"
              [class.text-indigo-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Extracted Intelligence
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Column 1: Financial & Links -->
            <div class="space-y-3">
               <!-- Bank Accounts -->
               <div>
                  <label class="text-[9px] uppercase font-bold opacity-70 block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Bank Accounts</label>
                  @if (intelligence().bankAccounts.length) {
                    <ul class="space-y-1">
                       @for (item of intelligence().bankAccounts; track item) {
                         <li class="text-[10px] md:text-xs font-mono p-1 rounded border flex items-center gap-2"
                             [class.bg-red-900_20]="!isTerminalMode()" [class.border-red-900_30]="!isTerminalMode()" [class.text-red-300]="!isTerminalMode()"
                             [class.bg-green-900_20]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                            <svg class="w-3 h-3 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" /></svg>
                            {{ item }}
                         </li>
                       }
                    </ul>
                  } @else {
                     <div class="text-[10px] italic opacity-40" [class.text-slate-500]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">None detected</div>
                  }
               </div>

               <!-- UPI -->
               <div>
                  <label class="text-[9px] uppercase font-bold opacity-70 block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">UPI IDs</label>
                  @if (intelligence().upiIds.length) {
                    <ul class="space-y-1">
                       @for (item of intelligence().upiIds; track item) {
                         <li class="text-[10px] md:text-xs font-mono p-1 rounded border flex items-center gap-2"
                             [class.bg-orange-900_20]="!isTerminalMode()" [class.border-orange-900_30]="!isTerminalMode()" [class.text-orange-300]="!isTerminalMode()"
                             [class.bg-green-900_20]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                            <svg class="w-3 h-3 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            {{ item }}
                         </li>
                       }
                    </ul>
                  } @else {
                     <div class="text-[10px] italic opacity-40" [class.text-slate-500]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">None detected</div>
                  }
               </div>
            </div>

            <!-- Column 2: Identity & Network -->
            <div class="space-y-3">
               <!-- Phone Numbers -->
               <div>
                  <label class="text-[9px] uppercase font-bold opacity-70 block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Phone Numbers</label>
                  @if (intelligence().phoneNumbers.length) {
                    <ul class="space-y-1">
                       @for (item of intelligence().phoneNumbers; track item) {
                         <li class="text-[10px] md:text-xs font-mono p-1 rounded border flex items-center gap-2"
                             [class.bg-blue-900_20]="!isTerminalMode()" [class.border-blue-900_30]="!isTerminalMode()" [class.text-blue-300]="!isTerminalMode()"
                             [class.bg-green-900_20]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                            <svg class="w-3 h-3 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                            {{ item }}
                         </li>
                       }
                    </ul>
                  } @else {
                     <div class="text-[10px] italic opacity-40" [class.text-slate-500]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">None detected</div>
                  }
               </div>
               
               <!-- Phishing Links -->
               <div>
                  <label class="text-[9px] uppercase font-bold opacity-70 block mb-1" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Phishing Links</label>
                  @if (intelligence().phishingLinks.length) {
                    <ul class="space-y-1">
                       @for (item of intelligence().phishingLinks; track item) {
                         <li class="text-[10px] md:text-xs font-mono p-1 rounded border flex items-center gap-2 break-all"
                             [class.bg-red-900_20]="!isTerminalMode()" [class.border-red-900_30]="!isTerminalMode()" [class.text-red-400]="!isTerminalMode()"
                             [class.bg-green-900_20]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                            <svg class="w-3 h-3 opacity-70 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                            {{ item }}
                         </li>
                       }
                    </ul>
                  } @else {
                     <div class="text-[10px] italic opacity-40" [class.text-slate-500]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">None detected</div>
                  }
               </div>
            </div>
          </div>
          
          <!-- Tactics & Keywords Tags -->
          <div class="mt-4 pt-3 border-t" [class.border-slate-800]="!isTerminalMode()" [class.border-green-900]="isTerminalMode()">
             <label class="text-[9px] uppercase font-bold opacity-70 block mb-2" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">Behavioral Triggers & Keywords</label>
             <div class="flex flex-wrap gap-1.5">
                @for (tactic of intelligence().socialEngineeringTactics; track tactic) {
                   <span class="px-2 py-0.5 rounded text-[10px] border font-semibold tracking-wide"
                         [class.bg-indigo-900_30]="!isTerminalMode()" [class.border-indigo-700]="!isTerminalMode()" [class.text-indigo-300]="!isTerminalMode()"
                         [class.bg-green-900_30]="isTerminalMode()" [class.border-green-700]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                     {{ tactic }}
                   </span>
                }
                @for (kw of intelligence().suspiciousKeywords; track kw) {
                   <span class="px-2 py-0.5 rounded text-[10px] border"
                         [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.text-slate-400]="!isTerminalMode()"
                         [class.bg-green-900_10]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-600]="isTerminalMode()">
                     {{ kw }}
                   </span>
                }
                @if (!intelligence().socialEngineeringTactics.length && !intelligence().suspiciousKeywords.length) {
                    <span class="text-[10px] italic opacity-40" [class.text-slate-500]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">No patterns identified</span>
                }
             </div>
          </div>

        </div>

        <!-- System Monitor (Request Payload / News) -->
        <div class="border rounded-xl p-3 md:p-5 shadow-sm flex flex-col min-h-[250px] md:min-h-0"
             [class.bg-slate-900_50]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
             [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
             
          <div class="flex items-center justify-between mb-2 md:mb-4">
            <h3 class="text-xs font-bold uppercase tracking-wider flex items-center gap-2 truncate"
                [class.text-indigo-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
              <span class="truncate">{{ monitorViewMode() === 'payload' ? 'Live Payload' : 'Threat Intel' }}</span>
            </h3>
            
            <div class="flex items-center gap-1.5 md:gap-2">
               <!-- Toggle Button -->
               <button (click)="toggleMonitorView()" 
                       class="text-[9px] md:text-[10px] px-2 py-1 rounded border transition-colors flex items-center gap-1 whitespace-nowrap"
                       [class.bg-slate-800]="!isTerminalMode()" [class.hover:bg-slate-700]="!isTerminalMode()" [class.text-slate-300]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()"
                       [class.bg-black]="isTerminalMode()" [class.hover:bg-green-900]="isTerminalMode()" [class.text-green-500]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                 @if (monitorViewMode() === 'payload') {
                   <span>Fetch News</span>
                 } @else {
                   <span>Show Payload</span>
                 }
               </button>

               <!-- IMPACT METRICS: Duration & Cost -->
               <div class="hidden sm:flex px-2 py-1 rounded text-[9px] md:text-[10px] font-mono border items-center gap-3"
                    [class.bg-slate-800]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()"
                    [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
                  
                  <div class="flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" [class.text-slate-400]="!isTerminalMode()" [class.text-green-600]="isTerminalMode()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span [class.text-white]="!isTerminalMode()" [class.text-green-400]="isTerminalMode()">{{ formattedDuration() }}</span>
                  </div>

                  <div class="w-px h-3" [class.bg-slate-600]="!isTerminalMode()" [class.bg-green-800]="isTerminalMode()"></div>

                  <div class="flex items-center gap-1.5">
                    <span [class.text-emerald-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()" class="font-bold">$</span>
                    <span [class.text-emerald-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()" class="font-bold">{{ scammerCost() }}</span>
                  </div>
               </div>
            </div>
          </div>
          
          <div class="flex-1 rounded border p-2 md:p-3 overflow-hidden relative group"
               [class.bg-slate-900]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
               [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
            
            @if (monitorViewMode() === 'payload') {
              <div class="absolute top-2 right-2 text-[9px] md:text-[10px] font-mono" [class.text-slate-600]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">
                 POST {{ backendMode() === 'PYTHON_LANGGRAPH' ? 'localhost:8000' : 'api.openai.com' }}
              </div>
              <pre class="font-mono text-[9px] md:text-[10px] text-green-400/90 whitespace-pre-wrap h-40 md:h-56 overflow-y-auto custom-scrollbar">{{ latestRequestPayload() ? (latestRequestPayload() | json) : '// No requests yet' }}</pre>
            } 
            
            @if (monitorViewMode() === 'news') {
              <div class="h-40 md:h-56 flex flex-col">
                 <div class="flex gap-2 mb-2 md:mb-3">
                   <input 
                     type="text" 
                     [(ngModel)]="newsFilter" 
                     (keyup.enter)="fetchNews()"
                     placeholder="Search threats (e.g. 'crypto')..."
                     class="flex-1 rounded px-2 py-1 text-[9px] md:text-[10px] focus:outline-none border"
                     [class.bg-slate-900]="!isTerminalMode()" [class.border-slate-700]="!isTerminalMode()" [class.focus:border-indigo-500]="!isTerminalMode()"
                     [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.focus:border-green-500]="isTerminalMode()" [class.text-green-400]="isTerminalMode()" [class.placeholder:text-green-800]="isTerminalMode()"
                   >
                   <button (click)="fetchNews()" class="px-2 py-1 rounded text-[9px] md:text-[10px] transition-colors"
                           [class.bg-indigo-600]="!isTerminalMode()" [class.text-white]="!isTerminalMode()" [class.hover:bg-indigo-500]="!isTerminalMode()"
                           [class.bg-green-800]="isTerminalMode()" [class.text-green-100]="isTerminalMode()" [class.hover:bg-green-700]="isTerminalMode()">
                     Search
                   </button>
                 </div>

                 <div class="flex-1 overflow-y-auto custom-scrollbar pr-1">
                   @if (isNewsLoading()) {
                     <div class="flex flex-col items-center justify-center h-full gap-2" [class.text-slate-500]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">
                       <div class="w-3 h-3 md:w-4 md:h-4 border-2 border-t-transparent rounded-full animate-spin" [class.border-indigo-500]="!isTerminalMode()" [class.border-green-500]="isTerminalMode()"></div>
                       <span class="text-[10px] md:text-xs">Fetching intelligence...</span>
                     </div>
                   } @else if (newsError()) {
                     <div class="flex flex-col items-center justify-center h-full text-red-400 gap-1 md:gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        <span class="text-[10px] md:text-xs text-center px-4">{{ newsError() }}</span>
                        <button (click)="fetchNews()" class="text-[9px] md:text-[10px] underline hover:text-red-300">Try Again</button>
                     </div>
                   } @else {
                     <ul class="space-y-2 md:space-y-3">
                       @for (item of newsHeadlines(); track item.id) {
                         <li class="border-b pb-2 last:border-0 last:pb-0" [class.border-slate-800]="!isTerminalMode()" [class.border-green-900]="isTerminalMode()">
                           <a [href]="item.url" target="_blank" class="block rounded transition-colors group" [class.hover:bg-slate-900]="!isTerminalMode()" [class.hover:bg-green-900_20]="isTerminalMode()">
                             <div class="text-[10px] md:text-[11px] font-medium leading-tight mb-1 truncate" [class.text-slate-300]="!isTerminalMode()" [class.group-hover:text-indigo-400]="!isTerminalMode()" [class.text-green-400]="isTerminalMode()">
                               {{ item.title }}
                             </div>
                             <div class="flex items-center gap-2 text-[8px] md:text-[9px]" [class.text-slate-600]="!isTerminalMode()" [class.text-green-700]="isTerminalMode()">
                               <span>{{ item.news_site }}</span>
                               <span>‚Ä¢</span>
                               <span>{{ item.published_at | date:'shortDate' }}</span>
                             </div>
                           </a>
                         </li>
                       }
                       @if (newsHeadlines().length === 0) {
                         <li class="text-[10px] md:text-xs text-center py-4" [class.text-slate-600]="!isTerminalMode()" [class.text-green-800]="isTerminalMode()">No results found</li>
                       }
                     </ul>
                   }
                 </div>
              </div>
            }

          </div>
        </div>
      </div>

      <!-- Callback Preview (Restored) -->
      <div class="border rounded-xl p-3 md:p-5 shadow-sm"
           [class.bg-slate-900_50]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
           [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()">
        <h3 class="text-xs font-bold uppercase tracking-wider mb-2 flex items-center justify-between"
            [class.text-indigo-400]="!isTerminalMode()" [class.text-green-500]="isTerminalMode()">
          <div class="flex items-center gap-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
             <span class="truncate">Final Result Callback</span>
          </div>
          <span class="text-[9px] font-normal normal-case px-2 py-1 rounded border hidden md:inline"
                [class.text-slate-500]="!isTerminalMode()" [class.bg-slate-900]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()"
                [class.text-green-700]="isTerminalMode()" [class.bg-black]="isTerminalMode()" [class.border-green-900]="isTerminalMode()">POST /api/updateHoneyPotFinalResult</span>
        </h3>
        <div class="rounded border p-2 md:p-4 font-mono text-[9px] md:text-[10px] whitespace-pre-wrap overflow-hidden h-20 md:h-auto custom-scrollbar overflow-y-auto"
             [class.bg-slate-950]="!isTerminalMode()" [class.border-slate-800]="!isTerminalMode()" [class.text-blue-300_90]="!isTerminalMode()"
             [class.bg-black]="isTerminalMode()" [class.border-green-800]="isTerminalMode()" [class.text-green-400]="isTerminalMode()">
          {{ finalCallbackPayload() | json }}
        </div>
      </div>

    </section>
  </main>
  
  <!-- Global Notification Toast -->
  @if (notificationMessage()) {
    <div class="fixed bottom-4 right-4 md:bottom-6 md:right-6 max-w-[90%] md:max-w-sm w-full p-3 md:p-4 rounded-lg shadow-2xl border z-50 animate-in slide-in-from-bottom-5 fade-in duration-300 backdrop-blur-md"
         [class.bg-red-900_90]="notificationType() === 'error' && !isTerminalMode()"
         [class.border-red-500]="notificationType() === 'error' && !isTerminalMode()"
         [class.text-white]="notificationType() === 'error' && !isTerminalMode()"
         
         [class.bg-slate-800_90]="notificationType() === 'info' && !isTerminalMode()"
         [class.border-slate-600]="notificationType() === 'info' && !isTerminalMode()"
         [class.text-slate-100]="notificationType() === 'info' && !isTerminalMode()"
         
         [class.bg-black]="isTerminalMode()"
         [class.border-red-600]="notificationType() === 'error' && isTerminalMode()"
         [class.text-red-500]="notificationType() === 'error' && isTerminalMode()"
         [class.border-green-600]="notificationType() === 'info' && isTerminalMode()"
         [class.text-green-500]="notificationType() === 'info' && isTerminalMode()">
         
       <div class="flex items-start gap-3">
          <div class="shrink-0 mt-0.5">
             @if (notificationType() === 'error') {
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
             } @else {
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
             }
          </div>
          <div class="flex-1 text-xs md:text-sm font-medium leading-tight">
            {{ notificationMessage() }}
          </div>
          <button (click)="dismissNotification()" class="opacity-70 hover:opacity-100 transition-opacity">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
       </div>
    </div>
  }
</div>