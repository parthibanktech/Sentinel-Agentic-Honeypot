name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HONEYPOT_API_KEY: ${{ secrets.HONEYPOT_API_KEY }}
        run: |
          # Save SSH key
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Create .ssh directory if it doesn't exist
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Add EC2 to known hosts
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          
          # Create deployment script with environment variables embedded
          cat > deploy_script.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Navigate to app directory
          cd ~/Sentinel-Agentic-Honeypot || {
            echo "Repository not found, cloning..."
            cd ~
            git clone https://github.com/parthibanktech/Sentinel-Agentic-Honeypot.git
            cd Sentinel-Agentic-Honeypot
          }
          
          # Pull latest changes
          echo "üì• Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main
          
          # Update environment variables
          echo "üîê Updating environment..."
          echo "OPENAI_API_KEY=$OPENAI_KEY" > backend/.env
          echo "HONEYPOT_API_KEY=$HONEYPOT_KEY" >> backend/.env
          echo "PORT=8000" >> backend/.env

          # Inject key into Angular environment
          sed -i "s/PLACEHOLDER_OPENAI_KEY/${OPENAI_KEY}/g" src/environments/environment.ts
          
          # Stop old container
          echo "üõë Stopping old container..."
          docker stop sentinel-honeypot 2>/dev/null || true
          docker rm sentinel-honeypot 2>/dev/null || true
          
          # Build new image
          echo "üèóÔ∏è Building Docker image..."
          docker build -t sentinel-honeypot .
          
          # Run new container
          echo "üöÄ Starting new container..."
          docker run -d \
            --name sentinel-honeypot \
            -p 80:8000 \
            --env-file backend/.env \
            --restart unless-stopped \
            sentinel-honeypot
          
          # Wait for startup
          sleep 5
          
          # Check status
          echo "‚úÖ Deployment complete!"
          docker ps | grep sentinel-honeypot
          
          # Show recent logs
          echo "üìù Recent logs:"
          docker logs --tail 20 sentinel-honeypot
          DEPLOY_SCRIPT
          
          # Copy script to EC2 and execute with environment variables
          scp -i private_key.pem -o StrictHostKeyChecking=no deploy_script.sh $USER@$HOST:~/deploy_script.sh
          ssh -i private_key.pem -o StrictHostKeyChecking=no $USER@$HOST "OPENAI_KEY='$OPENAI_API_KEY' HONEYPOT_KEY='$HONEYPOT_API_KEY' bash ~/deploy_script.sh && rm ~/deploy_script.sh"
          
          # Cleanup
          rm -f private_key.pem deploy_script.sh
          
          echo "‚úÖ Deployment successful!"
